# üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ MongoDB Unauthorized (–∫–æ–¥ 13)

## –ü—Ä–æ–±–ª–µ–º–∞

```
code: 13,
codeName: 'Unauthorized'
```

–û—à–∏–±–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ MongoDB —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–∞—Ä–æ–ª—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MongoDB

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
sudo cat /etc/mongod.conf | grep -A 2 "security:"
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
```yaml
security:
  authorization: enabled
```

–ó–Ω–∞—á–∏—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
mongosh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ invoice-db
use invoice-db
db.getUsers()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ admin
use admin
db.getUsers()

exit
```

## üîß –†–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –û—Ç–∫–ª—é—á–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

```bash
# 1. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo nano /etc/mongod.conf
```

–ù–∞–π–¥–∏—Ç–µ —Å–µ–∫—Ü–∏—é `security:` –∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ:
```yaml
# security:
#   authorization: enabled
```

```bash
# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ MongoDB
sudo systemctl restart mongod

# 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞
cd /var/www/davidsklad/backend
nano .env
```

–ò–∑–º–µ–Ω–∏—Ç–µ `MONGO_URI` –Ω–∞:
```env
MONGO_URI=mongodb://127.0.0.1:27017/invoice-db
```

```bash
# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pm2 restart davidsklad-backend

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
pm2 logs davidsklad-backend --lines 20
```

### –†–µ—à–µ–Ω–∏–µ 2: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é:

```bash
# 1. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sudo nano /etc/mongod.conf
# –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ security: authorization: enabled

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ MongoDB
sudo systemctl restart mongod

# 3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
mongosh

# 4. –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
use invoice-db
db.createUser({
  user: "invoice_user",
  pwd: "CGJ-Ge-90",
  roles: [ { role: "readWrite", db: "invoice-db" } ]
})

# 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ
db.getUsers()

# 6. –í—ã—Ö–æ–¥
exit
```

```bash
# 7. –í–∫–ª—é—á–∏—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ
sudo nano /etc/mongod.conf
# –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
# security:
#   authorization: enabled

# 8. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ MongoDB
sudo systemctl restart mongod

# 9. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
mongosh -u invoice_user -p CGJ-Ge-90 --authenticationDatabase invoice-db
```

–ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ, –æ–±–Ω–æ–≤–∏—Ç–µ `.env`:
```env
MONGO_URI=mongodb://invoice_user:CGJ-Ge-90@127.0.0.1:27017/invoice-db?authSource=invoice-db
```

### –†–µ—à–µ–Ω–∏–µ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å admin –±–∞–∑—É –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

–ò–Ω–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –≤ –±–∞–∑–µ `admin`:

```bash
# 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
mongosh

# 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ admin
use admin
db.createUser({
  user: "invoice_user",
  pwd: "CGJ-Ge-90",
  roles: [
    { role: "readWrite", db: "invoice-db" },
    { role: "readWrite", db: "admin" }
  ]
})

# 3. –í—ã—Ö–æ–¥
exit
```

–ó–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ `.env`:
```env
MONGO_URI=mongodb://invoice_user:CGJ-Ge-90@127.0.0.1:27017/invoice-db?authSource=admin
```

## ‚úÖ –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–æ—Ç–∫–ª—é—á–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é)

```bash
# 1. –û—Ç–∫–ª—é—á–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
sudo sed -i '/^security:/,/^[^ ]/ { /authorization:/d; }' /etc/mongod.conf

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å MongoDB
sudo systemctl restart mongod

# 3. –û–±–Ω–æ–≤–∏—Ç—å .env
cd /var/www/davidsklad/backend
sed -i 's|mongodb://.*@127.0.0.1:27017|mongodb://127.0.0.1:27017|g' .env
sed -i 's|mongodb://.*@localhost:27017|mongodb://127.0.0.1:27017|g' .env

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pm2 restart davidsklad-backend

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞
pm2 logs davidsklad-backend --lines 20
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ MongoDB`

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: Cookies –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è

–¢–∞–∫–∂–µ –≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö:
```
Auth middleware - cookies: { hasToken: false, tokenLength: 0, allCookies: [], headers: 'missing' }
```

–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ CORS. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `backend/src/index.ts`:

```typescript
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true,  // –í–ê–ñ–ù–û: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
```

–ò —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env` –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–∫–∞–∑–∞–Ω `FRONTEND_URL`:
```env
FRONTEND_URL=http://davidsklad.ru
```

---

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ –ª—É—á—à–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é MongoDB. –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ MongoDB –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ.

