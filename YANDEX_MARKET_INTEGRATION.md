# Интеграция с Яндекс Маркет Partner API

## Описание

Система интеграции с Яндекс Маркет Partner API для управления товарами в нескольких бизнесах одновременно. Товары объединяются по артикулу (vendorCode), что позволяет управлять одним товаром во всех бизнесах из одного места.

## Структура базы данных

### 1. YandexBusiness
Хранит информацию о бизнесах в Яндекс Маркете:
- `businessId` - ID бизнеса в Яндекс Маркете
- `name` - Название бизнеса
- `enabled` - Включен ли бизнес для синхронизации
- `accessToken` - OAuth токен для доступа к API
- `refreshToken` - Токен для обновления accessToken
- `tokenExpiresAt` - Время истечения токена
- `lastSyncAt` - Время последней синхронизации

### 2. YandexProduct
Хранит основную информацию о товаре (объединенную по артикулу):
- `vendorCode` - Артикул товара (ключевой идентификатор)
- `name` - Название товара
- `description` - Описание
- `images` - Массив URL изображений
- `category` - Категория товара

### 3. YandexProductBusinessLink
Связывает товар с бизнесом:
- `productId` - Ссылка на YandexProduct
- `businessId` - ID бизнеса
- `offerId` - ID оффера в Яндекс Маркете
- `sku` - SKU товара
- `price` - Текущая цена
- `stock` - Остатки (available, reserved)
- `status` - Статус карточки
- `lastSync` - Время последней синхронизации

## API Endpoints

### Синхронизация

#### Полная синхронизация товаров
```
POST /api/yandex-market/sync/products
```
Загружает все товары из всех активных бизнесов и объединяет их по артикулу.

#### Синхронизация остатков
```
POST /api/yandex-market/sync/stocks
```
Обновляет остатки товаров во всех бизнесах.

#### Синхронизация цен
```
POST /api/yandex-market/sync/prices
```
Обновляет цены товаров во всех бизнесах.

### Работа с товарами

#### Поиск товаров
```
GET /api/yandex-market/products/search?q={query}&limit={limit}
```
Поиск товаров по артикулу или названию.

#### Получить товар по артикулу
```
GET /api/yandex-market/products/:vendorCode
```
Возвращает товар со всеми бизнесами, где он присутствует.

#### Обновить цену во всех бизнесах
```
POST /api/yandex-market/products/update-price
Body: {
  vendorCode: string,
  price: number,
  currencyId: string (default: 'RUR')
}
```
Обновляет цену товара во всех бизнесах, где он присутствует.

## Использование

### 1. Настройка бизнесов

Создайте записи в таблице `YandexBusiness` для каждого бизнеса:
- Укажите `businessId` из Яндекс Маркета
- Добавьте `accessToken` (OAuth токен)
- Установите `enabled: true`

### 2. Полная синхронизация

Запустите полную синхронизацию для загрузки всех товаров:
```bash
POST /api/yandex-market/sync/products
```

Это загрузит:
- Все офферы из всех бизнесов
- Объединит товары по артикулу (vendorCode)
- Создаст связи между товарами и бизнесами

### 3. Инкрементальная синхронизация

Для обновления остатков и цен:
```bash
POST /api/yandex-market/sync/stocks  # Обновить остатки
POST /api/yandex-market/sync/prices  # Обновить цены
```

### 4. Управление ценами

Откройте страницу `/price-control`:
1. Введите артикул товара
2. Просмотрите список всех бизнесов, где есть этот товар
3. Введите новую цену
4. Нажмите "Обновить во всех магазинах"

Система автоматически обновит цену во всех бизнесах, где присутствует товар.

## Автоматическая синхронизация

Рекомендуется настроить автоматическую синхронизацию:

### Полная синхронизация (раз в сутки)
- Загружает все товары
- Пересоздает связи
- Обновляет основную информацию о товарах

### Инкрементальная синхронизация (каждый час)
- Обновляет остатки
- Обновляет цены

## Особенности

1. **Объединение по артикулу**: Если один и тот же артикул есть в нескольких бизнесах, это один товар в системе.

2. **Асинхронные запросы**: Все запросы к API выполняются асинхронно для ускорения работы.

3. **Обработка ошибок**: Система автоматически обрабатывает rate limits и повторяет запросы при ошибках.

4. **Пагинация**: Автоматическая обработка пагинации для всех методов API.

5. **Кэширование токенов**: Токены кэшируются для уменьшения количества запросов.

## Ограничения API

- Максимальный размер батча для обновления цен: 1000 офферов
- Rate limit: 100 запросов в секунду (система автоматически обрабатывает)
- Максимальный лимит на страницу: 1000 записей

## Логирование

Все операции логируются в консоль с префиксом `[YandexMarket]`:
- Загрузка товаров
- Обновление остатков
- Обновление цен
- Ошибки синхронизации

## Безопасность

- Все endpoints требуют аутентификации
- Endpoints синхронизации доступны только директору
- Страница управления ценами доступна только директору

